<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>IBP: database.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>database.cc</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="database_8h.html" title="Trida implementujici komunikaci mezi robotem a databazi.">database.h</a>&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="const_8h.html" title="Soubor konstant pro dotazy v jazyce SQL.">const.h</a>&quot;</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="comment">// konstruktor</span>
<a name="l00005"></a><a class="code" href="classDatabase.html#a4703c80e6969d33565ea340f768fdadf">00005</a> <a class="code" href="classDatabase.html#a4703c80e6969d33565ea340f768fdadf">Database::Database</a>()
<a name="l00006"></a>00006 {
<a name="l00007"></a>00007    this-&gt;<a class="code" href="classDatabase.html#a73a3ea4197118649af11db64a0905f26">m_hostaddr</a> = DB_ADDR;
<a name="l00008"></a>00008    this-&gt;m_dbname = DB_NAME;
<a name="l00009"></a>00009    this-&gt;m_user = DB_USER;
<a name="l00010"></a>00010    this-&gt;m_password = DB_PASS;
<a name="l00011"></a>00011    this-&gt;m_connectTimeout = DB_TIME;
<a name="l00012"></a>00012    this-&gt;m_port = DB_PORT;
<a name="l00013"></a>00013    this-&gt;m_connInfo = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00014"></a>00014 }
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="comment">// konstruktor</span>
<a name="l00017"></a><a class="code" href="classDatabase.html#a174f34007549b594df14306f1520238e">00017</a> <a class="code" href="classDatabase.html#a4703c80e6969d33565ea340f768fdadf">Database::Database</a>( std::string shostaddr, std::string sdbname, std::string suser, std::string spassword, std::string sconnectTimeout,  std::string sport )
<a name="l00018"></a>00018 {
<a name="l00019"></a>00019    this-&gt;<a class="code" href="classDatabase.html#a73a3ea4197118649af11db64a0905f26">m_hostaddr</a> = shostaddr;
<a name="l00020"></a>00020    this-&gt;m_dbname = sdbname;
<a name="l00021"></a>00021    this-&gt;m_user = suser;
<a name="l00022"></a>00022    this-&gt;m_password = spassword;
<a name="l00023"></a>00023    this-&gt;m_connectTimeout = sconnectTimeout;
<a name="l00024"></a>00024    this-&gt;m_port = sport;
<a name="l00025"></a>00025    this-&gt;m_connInfo = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00026"></a>00026 }
<a name="l00027"></a>00027 
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment">// vytvori retezec s udaji pro spojeni s databazi</span>
<a name="l00031"></a>00031 <span class="keywordtype">void</span> Database::makeStringConnect() {
<a name="l00032"></a>00032    
<a name="l00033"></a>00033    std::string shostaddr = <span class="stringliteral">&quot;hostaddr = &#39;&quot;</span>;
<a name="l00034"></a>00034    std::string sport = <span class="stringliteral">&quot;&#39; port = &#39;&quot;</span>;
<a name="l00035"></a>00035    std::string sdbname = <span class="stringliteral">&quot;&#39; dbname = &#39;&quot;</span>;
<a name="l00036"></a>00036    std::string suser = <span class="stringliteral">&quot;&#39; user = &#39;&quot;</span>;
<a name="l00037"></a>00037    std::string spassword = <span class="stringliteral">&quot;&#39; password = &#39;&quot;</span>;
<a name="l00038"></a>00038    std::string sconnect_timeout = <span class="stringliteral">&quot;&#39; connect_timeout = &#39;&quot;</span>;
<a name="l00039"></a>00039    std::string sconnInfo = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00040"></a>00040    this-&gt;m_connInfo += shostaddr + this-&gt;<a class="code" href="classDatabase.html#a73a3ea4197118649af11db64a0905f26">m_hostaddr</a> + sport + this-&gt;m_port + sdbname + this-&gt;m_dbname + suser + this-&gt;m_user + spassword + this-&gt;m_password + sconnect_timeout + this-&gt;m_connectTimeout +<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">// inicializace databaze (tvorba tabulek)</span>
<a name="l00045"></a>00045 <span class="keywordtype">void</span> Database::initDb() {
<a name="l00046"></a>00046 
<a name="l00047"></a>00047    <span class="keywordflow">if</span>( <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;logarea&quot;</span>, DB_TABLE_LOGAREA ) )
<a name="l00048"></a>00048    {
<a name="l00049"></a>00049       Database::insertTableConst( DB_DATA_LOGAREA );
<a name="l00050"></a>00050    }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052    <span class="keywordflow">if</span>( <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;level&quot;</span>, DB_TABLE_LOGAREA ) )
<a name="l00053"></a>00053    {
<a name="l00054"></a>00054       Database::insertTableConst( DB_DATA_LEVEL );
<a name="l00055"></a>00055    }
<a name="l00056"></a>00056    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;xml&quot;</span>, DB_TABLE_XML );
<a name="l00057"></a>00057    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;presence&quot;</span>, DB_TABLE_PRESENCE );
<a name="l00058"></a>00058    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;debug&quot;</span>, DB_TABLE_DEBUG );
<a name="l00059"></a>00059    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;vcard&quot;</span>, DB_TABLE_VCARD );
<a name="l00060"></a>00060    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;userjid&quot;</span>, DB_TABLE_USER );
<a name="l00061"></a>00061    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;message&quot;</span>, DB_TABLE_MESSAGE );
<a name="l00062"></a>00062    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;status&quot;</span>, DB_TABLE_STATUS );
<a name="l00063"></a>00063    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;resource&quot;</span>, DB_TABLE_RESOURCE );
<a name="l00064"></a>00064    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;geoloc&quot;</span>, DB_TABLE_GEOLOC );
<a name="l00065"></a>00065    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;tune&quot;</span>, DB_TABLE_TUNE );
<a name="l00066"></a>00066    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;mood&quot;</span>, DB_TABLE_MOOD );
<a name="l00067"></a>00067    <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="stringliteral">&quot;activity&quot;</span>, DB_TABLE_ACTIVITY );
<a name="l00068"></a>00068 
<a name="l00069"></a>00069    Database::clearResourceTable() ; 
<a name="l00070"></a>00070    <a class="code" href="classDatabase.html#a94ac4a7584707bfd40643e437e7471a8">Database::initListVer</a>();
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">// navazani spojeni s databazi</span>
<a name="l00074"></a>00074 <span class="keywordtype">void</span> Database::connect() {
<a name="l00075"></a>00075    
<a name="l00076"></a>00076    Database::makeStringConnect();
<a name="l00077"></a>00077    this-&gt;m_psql = PQconnectdb(this-&gt;m_connInfo.c_str());
<a name="l00078"></a>00078    <span class="keywordflow">if</span>( !this-&gt;m_psql )
<a name="l00079"></a>00079    {
<a name="l00080"></a>00080       fprintf(stderr, <span class="stringliteral">&quot;Error\n&quot;</span>);
<a name="l00081"></a>00081       Database::exitError();
<a name="l00082"></a>00082    }
<a name="l00083"></a>00083 
<a name="l00084"></a>00084    <span class="comment">//connect</span>
<a name="l00085"></a>00085    <span class="keywordflow">if</span>( PQstatus(this-&gt;m_psql) != CONNECTION_OK )
<a name="l00086"></a>00086    {
<a name="l00087"></a>00087       fprintf(stderr, <span class="stringliteral">&quot;chyba PRIPOJENI\n&quot;</span>);
<a name="l00088"></a>00088       Database::exitError();
<a name="l00089"></a>00089    }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">// tvorba vsech tabulek v databazi</span>
<a name="l00094"></a><a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">00094</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a4b48b0e706c1017b6ef0a4015b53080b">Database::createTable</a>( <span class="keyword">const</span> std::string nameTable, <span class="keyword">const</span> std::string structTable ) {
<a name="l00095"></a>00095 
<a name="l00096"></a>00096    std::string query = DB_SELECT_ALL + nameTable + <span class="stringliteral">&quot;;&quot;</span>;
<a name="l00097"></a>00097    this-&gt;m_presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00098"></a>00098    <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) == PGRES_TUPLES_OK)
<a name="l00099"></a>00099    {
<a name="l00100"></a>00100       <span class="comment">//printf(&quot;exec %s existuje&quot;, nameTable.c_str());</span>
<a name="l00101"></a>00101       PQclear(this-&gt;m_presult);
<a name="l00102"></a>00102       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00103"></a>00103    }
<a name="l00104"></a>00104    <span class="keywordflow">else</span>
<a name="l00105"></a>00105    {
<a name="l00106"></a>00106       query = DB_C_T + nameTable + <span class="stringliteral">&quot; (&quot;</span> + structTable + <span class="stringliteral">&quot;);&quot;</span>;
<a name="l00107"></a>00107       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00108"></a>00108       <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK)
<a name="l00109"></a>00109       {
<a name="l00110"></a>00110          fprintf(stderr, <span class="stringliteral">&quot;CHYNA dotazu\n&quot;</span>);
<a name="l00111"></a>00111          PQclear(this-&gt;m_presult);
<a name="l00112"></a>00112          Database::exitError();
<a name="l00113"></a>00113          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00114"></a>00114       }
<a name="l00115"></a>00115    }
<a name="l00116"></a>00116    PQclear(this-&gt;m_presult);
<a name="l00117"></a>00117    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="comment">// existuje uzivatel v databazi?</span>
<a name="l00121"></a>00121 <span class="keywordtype">bool</span> Database::existUser( <span class="keyword">const</span> std::string user ) {
<a name="l00122"></a>00122 
<a name="l00123"></a>00123    std::string query = <span class="stringliteral">&quot;Select jidbare from userjid where jidbare = &#39;&quot;</span>;
<a name="l00124"></a>00124    query += user + <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126    this-&gt;m_presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00127"></a>00127    <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) == PGRES_TUPLES_OK)
<a name="l00128"></a>00128    {
<a name="l00129"></a>00129       <span class="keywordflow">if</span>( PQntuples(this-&gt;m_presult) == 0 )
<a name="l00130"></a>00130          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00131"></a>00131       <span class="keywordflow">else</span>
<a name="l00132"></a>00132          <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00133"></a>00133    }
<a name="l00134"></a>00134    <span class="keywordflow">else</span>
<a name="l00135"></a>00135       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="comment">// je dane resource uzivatele v dattabazi?</span>
<a name="l00139"></a>00139 <span class="keywordtype">bool</span> Database::existResource( <span class="keyword">const</span> std::string user, <span class="keyword">const</span> std::string resource ) {
<a name="l00140"></a>00140 
<a name="l00141"></a>00141    std::string query = <span class="stringliteral">&quot;Select jidbare from resource where jidbare = &#39;&quot;</span>;
<a name="l00142"></a>00142    query += user + <span class="stringliteral">&quot;&#39; and resource = &#39;&quot;</span>;
<a name="l00143"></a>00143    query += resource + <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00144"></a>00144    this-&gt;m_presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00145"></a>00145    <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) == PGRES_TUPLES_OK)
<a name="l00146"></a>00146    {
<a name="l00147"></a>00147 
<a name="l00148"></a>00148       <span class="keywordflow">if</span>( PQntuples(this-&gt;m_presult) == 0 )
<a name="l00149"></a>00149          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00150"></a>00150       <span class="keywordflow">else</span>
<a name="l00151"></a>00151          <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00152"></a>00152    }
<a name="l00153"></a>00153    <span class="keywordflow">else</span>
<a name="l00154"></a>00154       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">// vlozeni data do tabulky const</span>
<a name="l00160"></a>00160 <span class="keywordtype">void</span> Database::insertTableConst( <span class="keyword">const</span> std::string query ) {
<a name="l00161"></a>00161    
<a name="l00162"></a>00162    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00163"></a>00163    <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00164"></a>00164    {
<a name="l00165"></a>00165       PQclear(this-&gt;m_presult);
<a name="l00166"></a>00166       Database::exitError();
<a name="l00167"></a>00167    }
<a name="l00168"></a>00168    PQclear(this-&gt;m_presult);
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="comment">//vrati true vkladam do DB</span>
<a name="l00172"></a>00172 <span class="keywordtype">bool</span> Database::insertGeoloc( std::string jid, <span class="keywordtype">bool</span> empty) {
<a name="l00173"></a>00173 
<a name="l00174"></a>00174    
<a name="l00175"></a>00175    this-&gt;sTime[17] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00176"></a>00176    this-&gt;sTime[18] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00177"></a>00177    std::string p_pom = <span class="stringliteral">&quot;SELECT id, lon, lat FROM geoloc WHERE jidbare = &#39;&quot;</span> +jid+<span class="stringliteral">&quot;&#39; AND time &gt;= timestamp &#39;&quot;</span>;
<a name="l00178"></a>00178    p_pom += this-&gt;sTime;
<a name="l00179"></a>00179    p_pom += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00180"></a>00180    this-&gt;m_presult = PQexec(this-&gt;m_psql, p_pom.c_str());
<a name="l00181"></a>00181    
<a name="l00182"></a>00182    <span class="keywordtype">int</span> nFields = PQnfields(this-&gt;m_presult);
<a name="l00183"></a>00183    <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185    <span class="keywordflow">if</span>( nTuples == 0 )               <span class="comment">// zaznam jesete neni v databazi</span>
<a name="l00186"></a>00186       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188    <span class="keywordflow">if</span>( !empty )            <span class="comment">// v databazi je udaj, chci vkladat ale novejsi neprazdny udaj, smazu stary z db</span>
<a name="l00189"></a>00189    {
<a name="l00190"></a>00190       std::string s = <span class="stringliteral">&quot;DELETE FROM geoloc where id =&#39;&quot;</span>;
<a name="l00191"></a>00191       s += PQgetvalue(this-&gt;m_presult,nTuples-1,0);
<a name="l00192"></a>00192       s += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00193"></a>00193       PQexec(this-&gt;m_psql, s.c_str());
<a name="l00194"></a>00194       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00195"></a>00195    }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="keywordtype">bool</span> Database::insertTune( <a class="code" href="classTune.html">Tune</a>* tune ) {
<a name="l00202"></a>00202 
<a name="l00203"></a>00203    
<a name="l00204"></a>00204    this-&gt;sTime[17] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00205"></a>00205    this-&gt;sTime[18] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00206"></a>00206    std::string p_pom = <span class="stringliteral">&quot;SELECT id, artist, source, title FROM tune WHERE jidbare = &#39;&quot;</span> +tune-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare()+<span class="stringliteral">&quot;&#39; AND time &gt;= timestamp &#39;&quot;</span>;
<a name="l00207"></a>00207    p_pom += this-&gt;sTime;
<a name="l00208"></a>00208    p_pom += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00209"></a>00209    this-&gt;m_presult = PQexec(this-&gt;m_psql, p_pom.c_str());
<a name="l00210"></a>00210    
<a name="l00211"></a>00211    <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213    <span class="keywordflow">if</span>( nTuples == 0 )               <span class="comment">// zaznam jesete neni v databazi</span>
<a name="l00214"></a>00214       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 
<a name="l00217"></a>00217    <span class="keywordflow">if</span>( PQgetvalue(this-&gt;m_presult,nTuples-1,1) == tune-&gt;artist() &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,2) == tune-&gt;title() &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,3) == tune-&gt;title() )
<a name="l00218"></a>00218       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00219"></a>00219    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( PQgetvalue(this-&gt;m_presult,nTuples-1,1) == <span class="stringliteral">&quot;&quot;</span> &amp;&amp; PQgetvalue(m_presult,nTuples-1,2) == <span class="stringliteral">&quot;&quot;</span> &amp;&amp; PQgetvalue(m_presult,nTuples-1,3) == <span class="stringliteral">&quot;&quot;</span> )
<a name="l00220"></a>00220    {
<a name="l00221"></a>00221       std::string s = <span class="stringliteral">&quot;DELETE FROM tune where id =&#39;&quot;</span>;
<a name="l00222"></a>00222       s += PQgetvalue(this-&gt;m_presult,nTuples-1,0);
<a name="l00223"></a>00223       s += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00224"></a>00224       PQexec(this-&gt;m_psql, s.c_str());
<a name="l00225"></a>00225       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00226"></a>00226    }
<a name="l00227"></a>00227    <span class="keywordflow">else</span>
<a name="l00228"></a>00228       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="keywordtype">bool</span> Database::insertMood( <a class="code" href="classMood.html">Mood</a>* mood ) {
<a name="l00234"></a>00234 
<a name="l00235"></a>00235    
<a name="l00236"></a>00236    this-&gt;sTime[17] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00237"></a>00237    this-&gt;sTime[18] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00238"></a>00238    std::string p_pom = <span class="stringliteral">&quot;SELECT id, mood, text FROM mood WHERE jidbare = &#39;&quot;</span> + mood-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare() + <span class="stringliteral">&quot;&#39; AND time &gt;= timestamp &#39;&quot;</span>;
<a name="l00239"></a>00239    p_pom += this-&gt;sTime;
<a name="l00240"></a>00240    p_pom += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00241"></a>00241    this-&gt;m_presult = PQexec(this-&gt;m_psql, p_pom.c_str());
<a name="l00242"></a>00242    
<a name="l00243"></a>00243    <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245    <span class="keywordflow">if</span>( nTuples == 0 )               <span class="comment">// zaznam jesete neni v databazi</span>
<a name="l00246"></a>00246       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248    <span class="keywordflow">if</span>( PQgetvalue(this-&gt;m_presult,nTuples-1,1) == mood-&gt;<a class="code" href="classMood.html#ab230f6ab2c1cf243fcc9e2427b143991">mood</a>() &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,2) == mood-&gt;<a class="code" href="classMood.html#aa327ec8f5f43d29f8156bfba98b6fcf2">text</a>() )
<a name="l00249"></a>00249       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00250"></a>00250    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( PQgetvalue(this-&gt;m_presult,nTuples-1,1) == <span class="stringliteral">&quot;&quot;</span> &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,2) == <span class="stringliteral">&quot;&quot;</span> )
<a name="l00251"></a>00251    {
<a name="l00252"></a>00252       std::string s = <span class="stringliteral">&quot;DELETE FROM mood where id =&#39;&quot;</span>;
<a name="l00253"></a>00253       s += PQgetvalue(this-&gt;m_presult,nTuples-1,0);
<a name="l00254"></a>00254       s += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00255"></a>00255       PQexec(this-&gt;m_psql, s.c_str());
<a name="l00256"></a>00256       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00257"></a>00257    }
<a name="l00258"></a>00258    <span class="keywordflow">else</span>
<a name="l00259"></a>00259       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="keywordtype">bool</span> Database::insertActivity( <a class="code" href="classActivity.html">Activity</a>* activity ) {
<a name="l00264"></a>00264 
<a name="l00265"></a>00265    this-&gt;sTime[17] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00266"></a>00266    this-&gt;sTime[18] = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00267"></a>00267    std::string p_pom = <span class="stringliteral">&quot;SELECT id, activity, spec, text FROM activity WHERE jidbare = &#39;&quot;</span> + activity-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare() + <span class="stringliteral">&quot;&#39; AND time &gt;= timestamp &#39;&quot;</span>;
<a name="l00268"></a>00268    p_pom += this-&gt;sTime;
<a name="l00269"></a>00269    p_pom += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00270"></a>00270    this-&gt;m_presult = PQexec(this-&gt;m_psql, p_pom.c_str());
<a name="l00271"></a>00271    
<a name="l00272"></a>00272    <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274    <span class="keywordflow">if</span>( nTuples == 0 )               <span class="comment">// zaznam jesete neni v databazi</span>
<a name="l00275"></a>00275       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277    <span class="keywordflow">if</span>( PQgetvalue(this-&gt;m_presult,nTuples-1,1) == activity-&gt;activity() &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,2) == activity-&gt;spec() &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,3) == activity-&gt;text() )
<a name="l00278"></a>00278       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00279"></a>00279    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( PQgetvalue(this-&gt;m_presult,nTuples-1,1) == <span class="stringliteral">&quot;&quot;</span> &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,2) == <span class="stringliteral">&quot;&quot;</span> &amp;&amp; PQgetvalue(this-&gt;m_presult,nTuples-1,3) == <span class="stringliteral">&quot;&quot;</span> )
<a name="l00280"></a>00280    {
<a name="l00281"></a>00281       std::string s = <span class="stringliteral">&quot;DELETE FROM activity where id =&#39;&quot;</span>;
<a name="l00282"></a>00282       s += PQgetvalue(this-&gt;m_presult,nTuples-1,0);
<a name="l00283"></a>00283       s += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00284"></a>00284       PQexec(this-&gt;m_psql, s.c_str());
<a name="l00285"></a>00285       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00286"></a>00286    }
<a name="l00287"></a>00287    <span class="keywordflow">else</span>
<a name="l00288"></a>00288       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment">// aktualizuje tabulku status</span>
<a name="l00292"></a>00292 <span class="keywordtype">void</span> Database::updateTableStatus( std::string jidBare,std::string presence,std::string status,std::string resource,std::string nameSW, std::string jingleVi, std::string jingleVo, std::string googleVo, std::string googleVi) {
<a name="l00293"></a>00293 
<a name="l00294"></a>00294    std::string query = DB_UPDATE;
<a name="l00295"></a>00295    query += <span class="stringliteral">&quot;status &quot;</span>;
<a name="l00296"></a>00296    query += DB_SET;
<a name="l00297"></a>00297    query += <span class="stringliteral">&quot;presence = &#39;&quot;</span> + presence + <span class="stringliteral">&quot;&#39;, status = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(status) + <span class="stringliteral">&quot;&#39;, date = timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, resource=&#39;&quot;</span> + resource + <span class="stringliteral">&quot;&#39; , nameSW = &#39;&quot;</span> + nameSW + <span class="stringliteral">&quot;&#39;, jingleVideo =&quot;</span>+boolToString(jingleVi) +<span class="stringliteral">&quot;, jingleVoice =&quot;</span>+boolToString(jingleVo)+ <span class="stringliteral">&quot;, googleVoice = &quot;</span>+boolToString(googleVo) +<span class="stringliteral">&quot;, googleVideo =&quot;</span>+boolToString(googleVi) + <span class="stringliteral">&quot; &quot;</span>+ DB_WHERE + <span class="stringliteral">&quot;jidbare = &#39;&quot;</span> + jidBare +<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00298"></a>00298 std::cout&lt;&lt;query&lt;&lt;std::endl;
<a name="l00299"></a>00299    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00300"></a>00300    <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00301"></a>00301    {
<a name="l00302"></a>00302       PQclear(this-&gt;m_presult);
<a name="l00303"></a>00303       Database::exitError();
<a name="l00304"></a>00304    }
<a name="l00305"></a>00305    PQclear(this-&gt;m_presult);
<a name="l00306"></a>00306 }
<a name="l00308"></a>00308 <span class="comment">/*</span>
<a name="l00309"></a>00309 <span class="comment">void Database::dropTable( const std::string nameTable ) {</span>
<a name="l00310"></a>00310 <span class="comment"></span>
<a name="l00311"></a>00311 <span class="comment">   std::string query = DB_D_T_I_E + nameTable + &quot;CASCADE;&quot;;</span>
<a name="l00312"></a>00312 <span class="comment">   this-&gt;m_presult = PQexec(this-&gt;m_psql, query.c_str());</span>
<a name="l00313"></a>00313 <span class="comment">   if(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK)</span>
<a name="l00314"></a>00314 <span class="comment">   {</span>
<a name="l00315"></a>00315 <span class="comment">      fprintf(stderr, &quot;CHYBA MAZANI TABLKY\n&quot;); </span>
<a name="l00316"></a>00316 <span class="comment">      PQclear(this-&gt;m_presult);</span>
<a name="l00317"></a>00317 <span class="comment">      Database::exitError();</span>
<a name="l00318"></a>00318 <span class="comment">   }</span>
<a name="l00319"></a>00319 <span class="comment">   PQclear(this-&gt;m_presult);</span>
<a name="l00320"></a>00320 <span class="comment">}</span>
<a name="l00321"></a>00321 <span class="comment">*/</span>
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="keywordtype">bool</span> Database::insertVCard( <span class="keyword">const</span> VCard * v, std::string jidBare ) {
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 
<a name="l00329"></a>00329    std::string p_pom = <span class="stringliteral">&quot;SELECT family, given, middle, prefix, suffix, nickname, url, bday, jabberid, title, role, note, mailer, rev, uid, tz, prodid, sortstring, photoExtval, photoBinval, photoType, logoExtval, logoBinval, logoType, geoLat, geoLon, orgName  FROM vcard WHERE dateadd= (SELECT MAX(dateadd) FROM vcard where jid = &#39;&quot;</span> + jidBare+<span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00330"></a>00330    
<a name="l00331"></a>00331    this-&gt;m_presult = PQexec(this-&gt;m_psql, p_pom.c_str());
<a name="l00332"></a>00332    
<a name="l00333"></a>00333    <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335    <span class="keywordflow">if</span>( nTuples == 0 )               <span class="comment">// zaznam jesete neni v databazi</span>
<a name="l00336"></a>00336       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="comment">// nekontroluje polozku orgUnits</span>
<a name="l00339"></a>00339    <span class="keywordflow">if</span>( PQgetvalue(this-&gt;m_presult,0,0) == v-&gt;name().family &amp;&amp;   PQgetvalue(m_presult,0,1) == v-&gt;name().given &amp;&amp; PQgetvalue(m_presult,0,2) == v-&gt;name().middle &amp;&amp; PQgetvalue(m_presult,0,3) == v-&gt;name().prefix &amp;&amp;
<a name="l00340"></a>00340     PQgetvalue(this-&gt;m_presult,0,4) == v-&gt;name().suffix &amp;&amp; PQgetvalue(m_presult,0,5) == v-&gt;nickname() &amp;&amp; PQgetvalue(m_presult,0,6) == v-&gt;url() &amp;&amp; PQgetvalue(m_presult,0,7) == v-&gt;bday() &amp;&amp;
<a name="l00341"></a>00341     PQgetvalue(this-&gt;m_presult,0,8) == v-&gt;jabberid() &amp;&amp;   PQgetvalue(m_presult,0,9) == v-&gt;title() &amp;&amp;   PQgetvalue(m_presult,0,10) == v-&gt;role() &amp;&amp;   PQgetvalue(m_presult,0,11) == v-&gt;note() &amp;&amp;
<a name="l00342"></a>00342     PQgetvalue(this-&gt;m_presult,0,12) == v-&gt;mailer() &amp;&amp; PQgetvalue(m_presult,0,13) == v-&gt;rev() &amp;&amp; PQgetvalue(m_presult,0,14) == v-&gt;uid() &amp;&amp; PQgetvalue(m_presult,0,15) == v-&gt;tz() &amp;&amp;
<a name="l00343"></a>00343     PQgetvalue(this-&gt;m_presult,0,16) == v-&gt;prodid() &amp;&amp; PQgetvalue(m_presult,0,17) == v-&gt;sortstring() &amp;&amp; PQgetvalue(m_presult,0,18) == v-&gt;photo().extval  &amp;&amp; 
<a name="l00344"></a>00344     PQgetvalue(this-&gt;m_presult,0,19) == <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(Base64::encode64(v-&gt;photo().binval))  &amp;&amp;  PQgetvalue(m_presult,0,20) == v-&gt;photo().type &amp;&amp; 
<a name="l00345"></a>00345     PQgetvalue(this-&gt;m_presult,0,21) == v-&gt;logo().extval &amp;&amp;  PQgetvalue(m_presult,0,22) == <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(Base64::encode64(v-&gt;logo().binval) ) &amp;&amp; PQgetvalue(m_presult,0,23) == v-&gt;logo().type &amp;&amp;
<a name="l00346"></a>00346     PQgetvalue(this-&gt;m_presult,0,24) == v-&gt;geo().latitude &amp;&amp;  PQgetvalue(m_presult,0,25) == v-&gt;geo().longitude  &amp;&amp;  PQgetvalue(m_presult,0,26) == v-&gt;org().name  )
<a name="l00347"></a>00347    {
<a name="l00348"></a>00348       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00349"></a>00349    }
<a name="l00350"></a>00350    <span class="keywordflow">else</span>
<a name="l00351"></a>00351       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 std::string Database::listToString( gloox::StringList units ) {
<a name="l00356"></a>00356 
<a name="l00357"></a>00357    std::string p_pom;
<a name="l00358"></a>00358    std::list&lt;std::string&gt;::iterator it;
<a name="l00359"></a>00359    <span class="keywordflow">for</span>( it = units.begin() ; it != units.end(); it++ )
<a name="l00360"></a>00360    {
<a name="l00361"></a>00361       p_pom += *it + <span class="stringliteral">&quot;, &quot;</span>;
<a name="l00362"></a>00362    }
<a name="l00363"></a>00363    <span class="keywordflow">return</span> p_pom;
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 
<a name="l00371"></a>00371 <span class="keywordtype">void</span> Database::exitError() {
<a name="l00372"></a>00372    PQfinish(this-&gt;m_psql);
<a name="l00373"></a>00373    <span class="comment">//exit(EXIT_FAILURE);</span>
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="comment">/*</span>
<a name="l00382"></a>00382 <span class="comment">void Database::dropAll() {</span>
<a name="l00383"></a>00383 <span class="comment"></span>
<a name="l00384"></a>00384 <span class="comment">   //Database::dropTable( &quot;debug&quot; );</span>
<a name="l00385"></a>00385 <span class="comment">   //Database::dropTable( &quot;level&quot; );</span>
<a name="l00386"></a>00386 <span class="comment">   //Database::dropTable( &quot;logarea&quot; );</span>
<a name="l00387"></a>00387 <span class="comment">   //Database::dropTable( &quot;userjid&quot; );</span>
<a name="l00388"></a>00388 <span class="comment">   //Database::dropTable( &quot;vcard&quot; );</span>
<a name="l00389"></a>00389 <span class="comment">   //Database::dropTable( &quot;xml&quot; );</span>
<a name="l00390"></a>00390 <span class="comment">   //Database::dropTable( &quot;presence&quot; );</span>
<a name="l00391"></a>00391 <span class="comment">   //Database::dropTable( &quot;message&quot; );</span>
<a name="l00392"></a>00392 <span class="comment">   //Database::dropTable( &quot;geoloc&quot; );</span>
<a name="l00393"></a>00393 <span class="comment"></span>
<a name="l00394"></a>00394 <span class="comment">}</span>
<a name="l00395"></a>00395 <span class="comment">*/</span>
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 std::string Database::select( std::string query, std::string jid )<span class="keyword"> const </span>{
<a name="l00398"></a>00398 
<a name="l00399"></a>00399    std::string result = <span class="stringliteral">&quot; &quot;</span>;
<a name="l00400"></a>00400    std::string ret = <span class="stringliteral">&quot; &quot;</span>;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402    <span class="keywordflow">if</span>( query == COMMAND_USER &amp;&amp; jid == ADMIN_JID )
<a name="l00403"></a>00403       result = printUser();
<a name="l00404"></a>00404    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( query == COMMAND_TUNE )
<a name="l00405"></a>00405       result = printTune(jid);
<a name="l00406"></a>00406    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( query == COMMAND_GEOLOC )
<a name="l00407"></a>00407       result = printGeoloc(jid);
<a name="l00408"></a>00408    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( query == COMMAND_MOOD )
<a name="l00409"></a>00409       result = printMood(jid);
<a name="l00410"></a>00410    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( query == COMMAND_ACTIVITY )
<a name="l00411"></a>00411       result = printActivity(jid);
<a name="l00412"></a>00412    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( query == COMMAND_HELP )
<a name="l00413"></a>00413       result = HELP_ECHO;
<a name="l00414"></a>00414    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( query == COMMAND_HALLO )
<a name="l00415"></a>00415       result = COMMAND_HALLO;
<a name="l00416"></a>00416    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( query == COMMAND_INFO )
<a name="l00417"></a>00417       result = INFO;
<a name="l00418"></a>00418    <span class="keywordflow">else</span>
<a name="l00419"></a>00419       ret = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421    <span class="keywordflow">if</span>( result == <span class="stringliteral">&quot;&quot;</span> )
<a name="l00422"></a>00422       ret = NO_SUPPORT;
<a name="l00423"></a>00423    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ret != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00424"></a>00424       ret = result;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426    <span class="keywordflow">return</span> ret;
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 std::string Database::printActivity( std::string jid )<span class="keyword"> const </span>{
<a name="l00430"></a>00430 
<a name="l00431"></a>00431    PGresult* presult;
<a name="l00432"></a>00432    std::string query =  <span class="stringliteral">&quot;SELECT activity, spec, time, text FROM activity where jidbare = &#39;&quot;</span> + jid + <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00433"></a>00433    presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00434"></a>00434    
<a name="l00435"></a>00435    <span class="keywordtype">int</span> nTuples = PQntuples(presult);
<a name="l00436"></a>00436    <span class="keywordtype">int</span> i = 0;
<a name="l00437"></a>00437    <span class="keywordflow">if</span>( nTuples &lt;= 0 )
<a name="l00438"></a>00438       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00439"></a>00439    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nTuples &gt; 2)
<a name="l00440"></a>00440       i = nTuples - 2;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442    std::string result;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444    <span class="keywordflow">for</span>( ; i &lt; nTuples; i++ )
<a name="l00445"></a>00445       result += <span class="stringliteral">&quot;\n&quot;</span> + std::string( PQgetvalue(presult,i , 2)) + <span class="stringliteral">&quot;, Activity : &quot;</span> + std::string( PQgetvalue(presult,i , 0)) + <span class="stringliteral">&quot; - &quot;</span> + std::string( PQgetvalue(presult,i , 1)) +  <span class="stringliteral">&quot; - &quot;</span> + std::string( PQgetvalue(presult,i , 3));
<a name="l00446"></a>00446    PQclear(presult);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448    <span class="keywordflow">return</span> result;
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 std::string Database::printMood( std::string jid )<span class="keyword"> const </span>{
<a name="l00452"></a>00452 
<a name="l00453"></a>00453    PGresult* presult;
<a name="l00454"></a>00454    std::string query =  <span class="stringliteral">&quot;SELECT mood, text , time FROM mood where jidbare = &#39;&quot;</span> + jid + <span class="stringliteral">&quot;&#39; AND mood != &#39;&#39;;&quot;</span>;
<a name="l00455"></a>00455    presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00456"></a>00456    
<a name="l00457"></a>00457    <span class="keywordtype">int</span> nTuples = PQntuples(presult);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459    <span class="keywordtype">int</span> i = 0;
<a name="l00460"></a>00460    <span class="keywordflow">if</span>( nTuples &lt;= 0 )
<a name="l00461"></a>00461       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00462"></a>00462    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nTuples &gt; 2)
<a name="l00463"></a>00463       i = nTuples - 2;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    std::string result;
<a name="l00466"></a>00466    <span class="keywordflow">for</span>( ; i &lt; nTuples; i++ )
<a name="l00467"></a>00467       result += <span class="stringliteral">&quot;\n&quot;</span> + std::string( PQgetvalue(presult,i , 2)) + <span class="stringliteral">&quot;, Mood : &quot;</span> + std::string( PQgetvalue(presult,i , 0)) + <span class="stringliteral">&quot; - &quot;</span> + std::string( PQgetvalue(presult,i , 1));
<a name="l00468"></a>00468       PQclear(presult);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470    <span class="keywordflow">return</span> result;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 std::string Database::printGeoloc(std::string jid)<span class="keyword"> const </span>{
<a name="l00474"></a>00474 
<a name="l00475"></a>00475    PGresult* presult;
<a name="l00476"></a>00476    std::string query =  <span class="stringliteral">&quot;SELECT lat, lon , time FROM geoloc where jidbare = &#39;&quot;</span> + jid + <span class="stringliteral">&quot;&#39; AND lat != 0 AND lon != 0;&quot;</span>;
<a name="l00477"></a>00477    presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00478"></a>00478 
<a name="l00479"></a>00479    <span class="keywordtype">int</span> i = 0;
<a name="l00480"></a>00480    <span class="keywordtype">int</span> nTuples = PQntuples(presult);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <span class="keywordflow">if</span>( nTuples &lt;= 0 )
<a name="l00483"></a>00483       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00484"></a>00484    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nTuples &gt; 2)
<a name="l00485"></a>00485       i = nTuples - 2;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487    std::string result;
<a name="l00488"></a>00488    <span class="keywordflow">for</span>( ; i &lt; nTuples; i++ )
<a name="l00489"></a>00489       result += <span class="stringliteral">&quot;\n&quot;</span> + std::string( PQgetvalue(presult,i , 2)) + <span class="stringliteral">&quot;, Lat : &quot;</span> + std::string( PQgetvalue(presult,i , 0)) + <span class="stringliteral">&quot;, Lon : &quot;</span> + std::string( PQgetvalue(presult,i , 1)); 
<a name="l00490"></a>00490 
<a name="l00491"></a>00491    PQclear(presult);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493    <span class="keywordflow">return</span> result;
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 std::string Database::printTune(std::string jid)<span class="keyword"> const </span>{
<a name="l00498"></a>00498 
<a name="l00499"></a>00499    PGresult* presult;
<a name="l00500"></a>00500    std::string query =  <span class="stringliteral">&quot;SELECT artist, title, track , time FROM tune where jidbare = &#39;&quot;</span> + jid + <span class="stringliteral">&quot;&#39; AND artist !=&#39;&#39; AND track !=&#39;&#39;;&quot;</span>;
<a name="l00501"></a>00501    presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00502"></a>00502    
<a name="l00503"></a>00503    <span class="keywordtype">int</span> i = 0;
<a name="l00504"></a>00504    <span class="keywordtype">int</span> nTuples = PQntuples(presult);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506    <span class="keywordflow">if</span>( nTuples &lt;= 0 )
<a name="l00507"></a>00507       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00508"></a>00508    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nTuples &gt; 2)
<a name="l00509"></a>00509       i = nTuples - 2;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511    std::string result;
<a name="l00512"></a>00512    <span class="keywordflow">for</span>( ; i &lt; nTuples; i++ )
<a name="l00513"></a>00513    {
<a name="l00514"></a>00514       result += <span class="stringliteral">&quot;\n&quot;</span> + std::string( PQgetvalue(presult,i , 3)) + <span class="stringliteral">&quot; - &quot;</span> + std::string( PQgetvalue(presult,i , 0)) + <span class="stringliteral">&quot; : &quot;</span> + std::string( PQgetvalue(presult,i , 1)) 
<a name="l00515"></a>00515             + <span class="stringliteral">&quot; = &quot;</span> + std::string( PQgetvalue(presult,i , 2)); 
<a name="l00516"></a>00516    }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518    PQclear(presult);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    <span class="keywordflow">return</span> result;
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 std::string Database::printUser()<span class="keyword"> const </span>{
<a name="l00524"></a>00524    
<a name="l00525"></a>00525    PGresult* presult;
<a name="l00526"></a>00526    presult = PQexec(this-&gt;m_psql, <span class="stringliteral">&quot;SELECT jidbare FROM userjid;&quot;</span>);
<a name="l00527"></a>00527    
<a name="l00528"></a>00528    <span class="keywordtype">int</span> nFields = PQnfields(presult);
<a name="l00529"></a>00529    <span class="keywordtype">int</span> nTuples = PQntuples(presult);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531    std::string result;
<a name="l00532"></a>00532    std::stringstream ss;
<a name="l00533"></a>00533    std::string back;
<a name="l00534"></a>00534    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nTuples; i++ )
<a name="l00535"></a>00535    {
<a name="l00536"></a>00536       ss &lt;&lt; PQgetvalue(presult,i , 0);
<a name="l00537"></a>00537       ss &gt;&gt; back;
<a name="l00538"></a>00538       result += <span class="stringliteral">&quot;\n - &quot;</span> + std::string( PQgetvalue(presult,i , 0));
<a name="l00539"></a>00539    }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541    PQclear(presult);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543    <span class="keywordflow">return</span> result;
<a name="l00544"></a>00544 }
<a name="l00545"></a>00545       
<a name="l00546"></a>00546       
<a name="l00547"></a>00547 <span class="keywordtype">void</span> Database::clearResourceTable( <span class="keywordtype">void</span> ) {
<a name="l00548"></a>00548 
<a name="l00549"></a>00549    this-&gt;m_presult = PQexec(this-&gt;m_psql, <span class="stringliteral">&quot;SELECT jidbare, presence, id FROM resource;&quot;</span>);
<a name="l00550"></a>00550    
<a name="l00551"></a>00551    <span class="keywordtype">int</span> nFields = PQnfields(this-&gt;m_presult);
<a name="l00552"></a>00552    <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554    std::string jid;
<a name="l00555"></a>00555    std::string p_str;
<a name="l00556"></a>00556    <span class="keywordtype">int</span> p_str1;
<a name="l00557"></a>00557    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nTuples; i++ )
<a name="l00558"></a>00558    {
<a name="l00559"></a>00559          jid = PQgetvalue(this-&gt;m_presult,i , 0);
<a name="l00560"></a>00560          mapVer.insert(make_pair(std::string(jid), std::string( PQgetvalue(this-&gt;m_presult,i , 2) )));
<a name="l00561"></a>00561    }
<a name="l00562"></a>00562    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nTuples; i++ )
<a name="l00563"></a>00563    {
<a name="l00564"></a>00564       <span class="keywordflow">if</span>( <span class="stringliteral">&quot;Unavaliable&quot;</span> == (p_str=PQgetvalue(this-&gt;m_presult,i,1)) )
<a name="l00565"></a>00565       {
<a name="l00566"></a>00566          <span class="keywordflow">if</span>( (<span class="keywordtype">int</span>)mapVer.count(PQgetvalue(this-&gt;m_presult,i,0)) &gt;= 200)
<a name="l00567"></a>00567          {
<a name="l00568"></a>00568             std::multimap&lt;std::string,std::string&gt;::iterator it1;
<a name="l00569"></a>00569             it1 = mapVer.find(PQgetvalue(this-&gt;m_presult, i,0));
<a name="l00570"></a>00570             std::string s = <span class="stringliteral">&quot;DELETE FROM resource where id =&#39;&quot;</span>;
<a name="l00571"></a>00571             s += PQgetvalue(this-&gt;m_presult,i,2);
<a name="l00572"></a>00572             s += <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00573"></a>00573             PQexec(this-&gt;m_psql, s.c_str());
<a name="l00574"></a>00574             mapVer.erase(it1);
<a name="l00575"></a>00575          }
<a name="l00576"></a>00576       }
<a name="l00577"></a>00577    }
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a><a class="code" href="classDatabase.html#a94ac4a7584707bfd40643e437e7471a8">00580</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a94ac4a7584707bfd40643e437e7471a8">Database::initListVer</a>( <span class="keywordtype">void</span> ) {
<a name="l00581"></a>00581 
<a name="l00582"></a>00582    this-&gt;m_presult = PQexec(this-&gt;m_psql, <span class="stringliteral">&quot;SELECT jidbare, resource, ver FROM resource;&quot;</span>);
<a name="l00583"></a>00583    
<a name="l00584"></a>00584    <span class="keywordtype">int</span> nFields = PQnfields(this-&gt;m_presult);
<a name="l00585"></a>00585    <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587    std::string jid;
<a name="l00588"></a>00588    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nTuples; i++ )
<a name="l00589"></a>00589    {
<a name="l00590"></a>00590          jid = PQgetvalue(this-&gt;m_presult,i , 0);
<a name="l00591"></a>00591          jid += <span class="stringliteral">&quot;/&quot;</span>;
<a name="l00592"></a>00592          jid += PQgetvalue(this-&gt;m_presult,i , 1);
<a name="l00593"></a>00593          listVer.insert(make_pair(std::string(jid), std::string( PQgetvalue(this-&gt;m_presult,i , 2) )));
<a name="l00594"></a>00594    }
<a name="l00595"></a>00595 <span class="comment">// std::map&lt;std::string,std::string&gt;::iterator it;</span>
<a name="l00596"></a>00596 <span class="comment">// for( it = listVer.begin(); it != listVer.end(); it++ )</span>
<a name="l00597"></a>00597 <span class="comment">// {</span>
<a name="l00598"></a>00598 <span class="comment">//    cout &lt;&lt; it-&gt;first &lt;&lt; it-&gt;second &lt;&lt;endl;</span>
<a name="l00599"></a>00599 <span class="comment">// }</span>
<a name="l00600"></a>00600    
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 <span class="comment">// zahaji spojeni s databazi a inicializaci</span>
<a name="l00609"></a><a class="code" href="classDatabase.html#a65c7d2cc56b627d6bb9ab4be25dad2dc">00609</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a65c7d2cc56b627d6bb9ab4be25dad2dc">Database::start</a>() {
<a name="l00610"></a>00610    
<a name="l00611"></a>00611    Database::connect();
<a name="l00612"></a>00612 
<a name="l00613"></a>00613    Database::initDb();
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616 <span class="comment">// ziskani aktualniho casu</span>
<a name="l00617"></a><a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">00617</a> <span class="keywordtype">char</span>* <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">Database::getTime</a>() {
<a name="l00618"></a>00618 
<a name="l00619"></a>00619    time_t times;
<a name="l00620"></a>00620    times = time(NULL);
<a name="l00621"></a>00621    <span class="keyword">struct </span>tm *ltmtime = localtime(&amp;times);
<a name="l00622"></a>00622    strftime(this-&gt;sTime, 80 - 1, <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S &quot;</span>, ltmtime);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624    <span class="keywordflow">return</span> this-&gt;sTime;
<a name="l00625"></a>00625 }
<a name="l00626"></a>00626 
<a name="l00628"></a>00628 
<a name="l00629"></a>00629 <span class="comment">// prevod obrazku z binarni podoby na retezec ASCII znaku</span>
<a name="l00630"></a><a class="code" href="classDatabase.html#a3199eea5fdae26872668a43f345841fd">00630</a> std::string <a class="code" href="classDatabase.html#a3199eea5fdae26872668a43f345841fd">Database::convertBinary</a>(std::string message ) {
<a name="l00631"></a>00631 
<a name="l00632"></a>00632    <span class="keywordtype">size_t</span> lenght = message.length();
<a name="l00633"></a>00633    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* mess;
<a name="l00634"></a>00634    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* y;
<a name="l00635"></a>00635    y = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* ) message.c_str();
<a name="l00636"></a>00636    <span class="keywordtype">size_t</span> len1 = 3*lenght+1;
<a name="l00637"></a>00637    <span class="keywordtype">size_t</span>* len = &amp;len1;
<a name="l00638"></a>00638    mess = PQescapeByteaConn( this-&gt;m_psql,y,    lenght,  len );
<a name="l00639"></a>00639    std::string blah = reinterpret_cast &lt; <span class="keyword">const</span> <span class="keywordtype">char</span>* &gt;( mess );
<a name="l00640"></a>00640    <span class="keywordflow">return</span> blah;
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 <span class="comment">// prevede znaky retezce pomoci ecape znaku, ktere je mozne ulozit do db</span>
<a name="l00644"></a><a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">00644</a> std::string <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(std::string message ) {
<a name="l00645"></a>00645 
<a name="l00646"></a>00646    <span class="keywordtype">size_t</span> lenght = message.length();
<a name="l00647"></a>00647    <span class="keywordtype">char</span> mess[2*lenght+1];
<a name="l00648"></a>00648    <span class="keyword">const</span> <span class="keywordtype">char</span>* pom = message.c_str();
<a name="l00649"></a>00649    PQescapeString( mess, pom, lenght );
<a name="l00650"></a>00650    std::string back(mess);
<a name="l00651"></a>00651    <span class="keywordflow">return</span> back;
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 
<a name="l00656"></a>00656 
<a name="l00657"></a>00657 <span class="comment">// vlozeni dat to tabulky activity</span>
<a name="l00658"></a><a class="code" href="classDatabase.html#ab313dba2c4a1ba81b6e81f0342e76f1f">00658</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#ab313dba2c4a1ba81b6e81f0342e76f1f">Database::insertTableActivity</a>( <a class="code" href="classActivity.html">Activity</a>* activity ) {
<a name="l00659"></a>00659 
<a name="l00660"></a>00660    <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">Database::getTime</a>();
<a name="l00661"></a>00661    std::string query = DB_DEF_ACTIVITY;
<a name="l00662"></a>00662    <span class="keywordflow">if</span>( insertActivity( activity ) )
<a name="l00663"></a>00663    {
<a name="l00664"></a>00664       query += <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00665"></a>00665       query += activity-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare() + <span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span>;
<a name="l00666"></a>00666       query += <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00667"></a>00667       query += <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + activity-&gt;<a class="code" href="classExtension.html#a92bcf7ea4ef0dc778e87f1ccc8c27351">id</a>() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( activity-&gt;activity() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( activity-&gt;spec() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( activity-&gt;text() ) + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00668"></a>00668       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00669"></a>00669       <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00670"></a>00670       {
<a name="l00671"></a>00671          PQclear(this-&gt;m_presult);
<a name="l00672"></a>00672          Database::exitError();
<a name="l00673"></a>00673       }
<a name="l00674"></a>00674       PQclear(this-&gt;m_presult);
<a name="l00675"></a>00675    }
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 <span class="comment">// vlozeni dat to tabulky mood</span>
<a name="l00679"></a><a class="code" href="classDatabase.html#a77052db1584364171f640ac6e17532bf">00679</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a77052db1584364171f640ac6e17532bf">Database::insertTableMood</a>( <a class="code" href="classMood.html">Mood</a>* mood ) {
<a name="l00680"></a>00680 
<a name="l00681"></a>00681    std::string query = DB_DEF_MOOD;
<a name="l00682"></a>00682    <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">Database::getTime</a>();
<a name="l00683"></a>00683 
<a name="l00684"></a>00684    <span class="keywordflow">if</span>( insertMood( mood ) )
<a name="l00685"></a>00685    {
<a name="l00686"></a>00686       query += <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00687"></a>00687       query += mood-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare() + <span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span>;
<a name="l00688"></a>00688       query += <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00689"></a>00689       query += <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + mood-&gt;<a class="code" href="classExtension.html#a92bcf7ea4ef0dc778e87f1ccc8c27351">id</a>() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( mood-&gt;<a class="code" href="classMood.html#ab230f6ab2c1cf243fcc9e2427b143991">mood</a>() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( mood-&gt;<a class="code" href="classMood.html#aa327ec8f5f43d29f8156bfba98b6fcf2">text</a>() ) + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00690"></a>00690       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00691"></a>00691       <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00692"></a>00692       {
<a name="l00693"></a>00693          PQclear(this-&gt;m_presult);
<a name="l00694"></a>00694          Database::exitError();
<a name="l00695"></a>00695       }
<a name="l00696"></a>00696       PQclear(this-&gt;m_presult);
<a name="l00697"></a>00697    }
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 <span class="comment">// vlozeni dat to tabulky tune</span>
<a name="l00701"></a><a class="code" href="classDatabase.html#a23060c24f9d5fcfb85d302e30882b62d">00701</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a23060c24f9d5fcfb85d302e30882b62d">Database::insertTableTune</a>( <a class="code" href="classTune.html">Tune</a>* tune ) {
<a name="l00702"></a>00702 
<a name="l00703"></a>00703    <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">Database::getTime</a>();
<a name="l00704"></a>00704    std::string query = DB_DEF_TUNE;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706    <span class="keywordflow">if</span>( insertTune(tune))
<a name="l00707"></a>00707    {
<a name="l00708"></a>00708       query += <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00709"></a>00709       query += tune-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare() + <span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span>;
<a name="l00710"></a>00710       query += <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00711"></a>00711       query += <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + tune-&gt;<a class="code" href="classExtension.html#a92bcf7ea4ef0dc778e87f1ccc8c27351">id</a>() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( tune-&gt;artist() ) + <span class="stringliteral">&quot;&#39;, &quot;</span> + numToStr(tune-&gt;length()) + <span class="stringliteral">&quot;, &quot;</span> + numToStr(tune-&gt;rating()) + <span class="stringliteral">&quot;, &#39;&quot;</span> 
<a name="l00712"></a>00712       + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( tune-&gt;source() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span>   + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( tune-&gt;title() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( tune-&gt;track() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( tune-&gt;uri() ) + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00713"></a>00713       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00714"></a>00714       <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00715"></a>00715       {
<a name="l00716"></a>00716          PQclear(this-&gt;m_presult);
<a name="l00717"></a>00717          Database::exitError();
<a name="l00718"></a>00718       }
<a name="l00719"></a>00719       PQclear(this-&gt;m_presult);
<a name="l00720"></a>00720    }
<a name="l00721"></a>00721 }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 <span class="comment">// vlozeni dat to tabulky geoloc</span>
<a name="l00724"></a><a class="code" href="classDatabase.html#ac5e578fc33954b0cb1e52c2d95d3ca0b">00724</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#ac5e578fc33954b0cb1e52c2d95d3ca0b">Database::insertTableGeoloc</a>( <a class="code" href="classGeoloc.html">Geoloc</a>* geoloc ) {
<a name="l00725"></a>00725 
<a name="l00726"></a>00726    std::string query = DB_DEF_GEOLOC;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728    <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">Database::getTime</a>();
<a name="l00729"></a>00729    <span class="keywordtype">bool</span> cont = <span class="keyword">true</span>;
<a name="l00730"></a>00730    <span class="keywordflow">if</span>( geoloc-&gt;lon() == 0 &amp;&amp; geoloc-&gt;lat() == 0 )
<a name="l00731"></a>00731    {
<a name="l00732"></a>00732       cont = insertGeoloc( geoloc-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare(), true );
<a name="l00733"></a>00733    }
<a name="l00734"></a>00734    <span class="keywordflow">else</span>
<a name="l00735"></a>00735       cont = insertGeoloc( geoloc-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare(), false );
<a name="l00736"></a>00736 
<a name="l00737"></a>00737    <span class="keywordflow">if</span>( cont )
<a name="l00738"></a>00738    {
<a name="l00739"></a>00739       std::string p_str = geoloc-&gt;timestamp();
<a name="l00740"></a>00740       <span class="keywordflow">if</span>( geoloc-&gt;timestamp() == <span class="stringliteral">&quot;&quot;</span> )
<a name="l00741"></a>00741          p_str = <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00742"></a>00742 
<a name="l00743"></a>00743       query += <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00744"></a>00744       query += geoloc-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare() + <span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span>;
<a name="l00745"></a>00745       query += <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00746"></a>00746       query += <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + geoloc-&gt;<a class="code" href="classExtension.html#a92bcf7ea4ef0dc778e87f1ccc8c27351">id</a>() + <span class="stringliteral">&quot;&#39;, &quot;</span> + numToStr( geoloc-&gt;accuracy() ) + <span class="stringliteral">&quot;, &quot;</span> + numToStr(geoloc-&gt;alt()) + <span class="stringliteral">&quot;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(geoloc-&gt;area()) + <span class="stringliteral">&quot;&#39;, &quot;</span> 
<a name="l00747"></a>00747       + numToStr( geoloc-&gt;bearing() ) + <span class="stringliteral">&quot;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;building() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;country() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> 
<a name="l00748"></a>00748       + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;countrycode() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;datum() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;description() ) + <span class="stringliteral">&quot;&#39;, &quot;</span> + numToStr( geoloc-&gt;error() ) 
<a name="l00749"></a>00749       + <span class="stringliteral">&quot;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;floor() ) + <span class="stringliteral">&quot;&#39;, &quot;</span> + numToStr( geoloc-&gt;lat() ) + <span class="stringliteral">&quot;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;locality() ) + <span class="stringliteral">&quot;&#39;, &quot;</span> + numToStr( geoloc-&gt;lon() ) 
<a name="l00750"></a>00750       + <span class="stringliteral">&quot;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;postalcode() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;region() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;room() ) + <span class="stringliteral">&quot;&#39;, &quot;</span> + numToStr( geoloc-&gt;speed() ) 
<a name="l00751"></a>00751       + <span class="stringliteral">&quot;, &#39;&quot;</span>  + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;street() ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;text() ) + <span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(p_str ) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( geoloc-&gt;uri() ) + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00752"></a>00752       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00753"></a>00753       <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00754"></a>00754       {
<a name="l00755"></a>00755          PQclear(this-&gt;m_presult);
<a name="l00756"></a>00756          Database::exitError();
<a name="l00757"></a>00757       }
<a name="l00758"></a>00758       PQclear(this-&gt;m_presult);
<a name="l00759"></a>00759    }
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00762"></a>00762 <span class="comment">// vlozeni dat to tabulky vcard</span>
<a name="l00763"></a><a class="code" href="classDatabase.html#a1bc61aab7507950d0cca002b05693fd1">00763</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a1bc61aab7507950d0cca002b05693fd1">Database::insertTableVCard</a>( <span class="keyword">const</span> VCard* v , std::string jidBare) {
<a name="l00764"></a>00764 
<a name="l00765"></a>00765    <span class="keywordflow">if</span>( insertVCard( v, jidBare ) )
<a name="l00766"></a>00766    {
<a name="l00767"></a>00767       std::string query = DB_INSERT;
<a name="l00768"></a>00768       query += <span class="stringliteral">&quot;vcard ( jid, dateAdd, family, given, middle, prefix, suffix, nickname, url, bday, jabberid, title, role, note, mailer, rev, uid, tz, prodid, sortstring, photoExtval, photoBinval, photoType, logoExtval, logoBinval, logoType, geoLat, geoLon, orgName, orgUnits) VALUES ( &#39;&quot;</span>;
<a name="l00769"></a>00769       query += jidBare + <span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;name().family + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;name().given + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;name().middle + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;name().prefix + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;name().suffix + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;nickname() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;url() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span>;
<a name="l00770"></a>00770       query += v-&gt;bday() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;jabberid() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;title() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;role() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;note() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;mailer() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;rev() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;uid() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;tz() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;prodid() + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span>; 
<a name="l00771"></a>00771       query += v-&gt;sortstring() + <span class="stringliteral">&quot;&#39;,&#39;&quot;</span> + v-&gt;photo().extval + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(Base64::encode64(v-&gt;photo().binval)) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;photo().type + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + v-&gt;logo().extval + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(Base64::encode64(v-&gt;logo().binval)) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(v-&gt;logo().type) + <span class="stringliteral">&quot;&#39;,&quot;</span>;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773       <span class="keywordflow">if</span>( v-&gt;geo().latitude == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00774"></a>00774          query +=  <span class="stringliteral">&quot;0, &quot;</span>;
<a name="l00775"></a>00775       <span class="keywordflow">else</span>
<a name="l00776"></a>00776          query += v-&gt;geo().latitude + <span class="stringliteral">&quot;, &quot;</span>;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778       <span class="keywordflow">if</span>( v-&gt;geo().longitude == <span class="stringliteral">&quot;&quot;</span> )
<a name="l00779"></a>00779          query += <span class="stringliteral">&quot;0, &#39;&quot;</span>;
<a name="l00780"></a>00780       <span class="keywordflow">else</span>
<a name="l00781"></a>00781          query +=  v-&gt;geo().longitude + <span class="stringliteral">&quot;, &#39;&quot;</span>;
<a name="l00782"></a>00782          
<a name="l00783"></a>00783       query += v-&gt;org().name + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span>+listToString(v-&gt;org().units)+<span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00786"></a>00786       <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00787"></a>00787       {
<a name="l00788"></a>00788          PQclear(this-&gt;m_presult);
<a name="l00789"></a>00789          Database::exitError();
<a name="l00790"></a>00790       }
<a name="l00791"></a>00791       PQclear(this-&gt;m_presult);
<a name="l00792"></a>00792    }
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="comment">// vlozeni dat to tabulky user</span>
<a name="l00796"></a><a class="code" href="classDatabase.html#ae3d08a778ad3e3bb916b9a0710e17591">00796</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#ae3d08a778ad3e3bb916b9a0710e17591">Database::insertTableUser</a>( std::string jidBare) {
<a name="l00797"></a>00797 
<a name="l00798"></a>00798    <span class="keywordflow">if</span>( !existUser(jidBare) )<span class="comment">//vlozeni noveho uzivatele</span>
<a name="l00799"></a>00799    {
<a name="l00800"></a>00800       std::string query = DB_INSERT;
<a name="l00801"></a>00801       query += <span class="stringliteral">&quot;userjid (jidbare, date) VALUES (&#39;&quot;</span>+ jidBare + <span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00802"></a>00802       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00803"></a>00803       <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00804"></a>00804       {
<a name="l00805"></a>00805          PQclear(this-&gt;m_presult);
<a name="l00806"></a>00806          Database::exitError();
<a name="l00807"></a>00807       }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809       <span class="comment">//status insert user</span>
<a name="l00810"></a>00810       query = DB_INSERT;
<a name="l00811"></a>00811       query += <span class="stringliteral">&quot;status (jidbare) VALUES (&#39;&quot;</span>+ jidBare + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00812"></a>00812       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00813"></a>00813       <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00814"></a>00814       {
<a name="l00815"></a>00815          PQclear(this-&gt;m_presult);
<a name="l00816"></a>00816          Database::exitError();
<a name="l00817"></a>00817       }
<a name="l00818"></a>00818    }
<a name="l00819"></a>00819    PQclear(this-&gt;m_presult);
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 <span class="comment">// vlozeni dat to tabulky debug</span>
<a name="l00823"></a><a class="code" href="classDatabase.html#adf308c272ed2354c9b4b0adec7e7514c">00823</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#adf308c272ed2354c9b4b0adec7e7514c">Database::insertTableDebug</a>( <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> area, <span class="keyword">const</span> std::string message ) {
<a name="l00824"></a>00824 
<a name="l00825"></a>00825    std::string query = DB_INSERT;
<a name="l00826"></a>00826    query += <span class="stringliteral">&quot;debug ( area, dateAdd, level, message) VALUES (&quot;</span>+ numToStr(area) + <span class="stringliteral">&quot;, timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, &quot;</span>;
<a name="l00827"></a>00827    query += numToStr( level ) + <span class="stringliteral">&quot;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(message) + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00828"></a>00828    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00829"></a>00829    <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00830"></a>00830    {
<a name="l00831"></a>00831       PQclear(this-&gt;m_presult);
<a name="l00832"></a>00832       Database::exitError();
<a name="l00833"></a>00833    }
<a name="l00834"></a>00834    <span class="keywordflow">else</span>
<a name="l00835"></a>00835    {
<a name="l00836"></a>00836 
<a name="l00837"></a>00837       PQclear(this-&gt;m_presult);
<a name="l00838"></a>00838    }
<a name="l00839"></a>00839 }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841 <span class="comment">// vlozeni dat to tabulky xml</span>
<a name="l00842"></a><a class="code" href="classDatabase.html#a91c467c7d88fa73d47f90b00810639ce">00842</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a91c467c7d88fa73d47f90b00810639ce">Database::insertTableXML</a>( <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> area, <span class="keyword">const</span> std::string message ) {
<a name="l00843"></a>00843 
<a name="l00844"></a>00844    std::string query = DB_INSERT;
<a name="l00845"></a>00845    query += <span class="stringliteral">&quot;xml ( area, dateAdd, level, message) VALUES (&quot;</span>+ numToStr(area) + <span class="stringliteral">&quot;, timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, &quot;</span>;
<a name="l00846"></a>00846    query += numToStr( level ) + <span class="stringliteral">&quot;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(message) + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00847"></a>00847    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00848"></a>00848    <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00849"></a>00849    {
<a name="l00850"></a>00850       PQclear(this-&gt;m_presult);
<a name="l00851"></a>00851       Database::exitError();
<a name="l00852"></a>00852    }
<a name="l00853"></a>00853    <span class="keywordflow">else</span>
<a name="l00854"></a>00854    {
<a name="l00855"></a>00855       PQclear(this-&gt;m_presult);
<a name="l00856"></a>00856    }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 <span class="comment">// vlozeni dat to tabulky message</span>
<a name="l00861"></a><a class="code" href="classDatabase.html#a9d4abee71fe85d95e34537212a2b1860">00861</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a9d4abee71fe85d95e34537212a2b1860">Database::insertTableMessage</a>( <span class="keyword">const</span> std::string jid, <span class="keyword">const</span> std::string msg, <span class="keyword">const</span> std::string subject, <span class="keyword">const</span> std::string thread, <span class="keyword">const</span> std::string subtype ) {
<a name="l00862"></a>00862 
<a name="l00863"></a>00863    std::string query = DB_DEF_MESSAGE;
<a name="l00864"></a>00864    query += <span class="stringliteral">&quot;timestamp &#39;&quot;</span>;
<a name="l00865"></a>00865    query += <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00866"></a>00866    query += <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + jid + <span class="stringliteral">&quot;&#39;, &#39;JabInfo@jabbim.com&#39;, &#39;&quot;</span>;
<a name="l00867"></a>00867    query += <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(msg) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + subject + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + thread + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + subtype + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00868"></a>00868    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00869"></a>00869    <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00870"></a>00870    {
<a name="l00871"></a>00871       PQclear(this-&gt;m_presult);
<a name="l00872"></a>00872       Database::exitError();
<a name="l00873"></a>00873    }
<a name="l00874"></a>00874    PQclear(this-&gt;m_presult);
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 <span class="comment">// vlozeni dat to tabulky presence</span>
<a name="l00879"></a><a class="code" href="classDatabase.html#ac224d84f32afe5b4700339b4ed1cbcba">00879</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#ac224d84f32afe5b4700339b4ed1cbcba">Database::insertTablePresence</a>( <span class="keyword">const</span> std::string jid, <span class="keyword">const</span> std::string msg, <span class="keyword">const</span> std::string name, <span class="keyword">const</span> std::string resource, <span class="keyword">const</span> std::string presence, <span class="keyword">const</span> <span class="keywordtype">int</span> priority, <span class="keyword">const</span> std::string nameSW, <span class="keyword">const</span> std::string versionSW, <span class="keyword">const</span> std::string osSW ) {
<a name="l00880"></a>00880 
<a name="l00881"></a>00881    std::string query = DB_DEF_PRESENCE;
<a name="l00882"></a>00882    query += <span class="stringliteral">&quot;timestamp &#39;&quot;</span>;
<a name="l00883"></a>00883    query += <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00884"></a>00884    query += <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + jid + <span class="stringliteral">&quot;&#39;, &#39;JabInfo@jabbim.com&#39;, &#39;&quot;</span>;
<a name="l00885"></a>00885    query += <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(msg) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> +  name + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + resource + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(presence) + <span class="stringliteral">&quot;&#39;, &quot;</span> + numToStr( priority )+<span class="stringliteral">&quot;, &#39;&quot;</span> + nameSW + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + versionSW + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + osSW + <span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l00886"></a>00886    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00887"></a>00887    <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00888"></a>00888    {
<a name="l00889"></a>00889       PQclear(this-&gt;m_presult);
<a name="l00890"></a>00890       Database::exitError();
<a name="l00891"></a>00891    }
<a name="l00892"></a>00892    PQclear(this-&gt;m_presult);
<a name="l00893"></a>00893 }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 <span class="comment">// vlozeni dat to tabulky presence</span>
<a name="l00896"></a><a class="code" href="classDatabase.html#a23e89aa424f735e5510760e6dcb5e7ae">00896</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#ac224d84f32afe5b4700339b4ed1cbcba">Database::insertTablePresence</a>( <span class="keyword">const</span> std::string jid, <span class="keyword">const</span> std::string msg, <span class="keyword">const</span> std::string name, <span class="keyword">const</span> std::string resource, <span class="keyword">const</span> std::string presence ) {
<a name="l00897"></a>00897 
<a name="l00898"></a>00898    std::string query = DB_DEF_PRESENCE1;
<a name="l00899"></a>00899    query += <span class="stringliteral">&quot;timestamp &#39;&quot;</span>;
<a name="l00900"></a>00900    query += <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>();
<a name="l00901"></a>00901    query += <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + jid + <span class="stringliteral">&quot;&#39;, &#39;JabInfo@jabbim.com&#39;, &#39;&quot;</span>; 
<a name="l00902"></a>00902    query += <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(msg) + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> +  name + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + resource + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span> + presence + <span class="stringliteral">&quot;&#39;, 0 );&quot;</span>;
<a name="l00903"></a>00903    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00904"></a>00904    <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00905"></a>00905    {
<a name="l00906"></a>00906       PQclear(this-&gt;m_presult);
<a name="l00907"></a>00907       Database::exitError();
<a name="l00908"></a>00908    }
<a name="l00909"></a>00909    PQclear(this-&gt;m_presult);
<a name="l00910"></a>00910 }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 <span class="comment">// aktualizauje stav tabulky STATUS</span>
<a name="l00914"></a><a class="code" href="classDatabase.html#a277f3480f7ac16380ea0195d2a3d1c14">00914</a> <span class="keywordtype">void</span> Database::updateTableStatus( std::string user ) {
<a name="l00915"></a>00915 
<a name="l00916"></a>00916    std::string query = <span class="stringliteral">&quot;Select * from resource where jidbare = &#39;&quot;</span>;
<a name="l00917"></a>00917    query += user + <span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00918"></a>00918    this-&gt;m_presult = PQexec(this-&gt;m_psql, query.c_str());
<a name="l00919"></a>00919    <span class="keywordflow">if</span>(PQresultStatus(this-&gt;m_presult) == PGRES_TUPLES_OK)
<a name="l00920"></a>00920    {
<a name="l00921"></a>00921       <span class="keywordtype">int</span> nFields = PQnfields(this-&gt;m_presult); <span class="comment">//sloupec</span>
<a name="l00922"></a>00922       <span class="keywordtype">int</span> nTuples = PQntuples(this-&gt;m_presult); <span class="comment">//radek</span>
<a name="l00923"></a>00923       <span class="keywordtype">int</span> priority = -127;
<a name="l00924"></a>00924       std::string pom, pomS;
<a name="l00925"></a>00925       <span class="keywordtype">int</span> pomInt = 0;
<a name="l00926"></a>00926       <span class="keywordtype">int</span> culomn = -1;
<a name="l00927"></a>00927       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nTuples; i++ )
<a name="l00928"></a>00928       {
<a name="l00929"></a>00929             pom = PQgetvalue(this-&gt;m_presult,i,5);
<a name="l00930"></a>00930             pomS = PQgetvalue(this-&gt;m_presult,i,2);
<a name="l00931"></a>00931             std::string some_string;
<a name="l00932"></a>00932             std::istringstream buffer(pom);
<a name="l00933"></a>00933             buffer &gt;&gt; pomInt;
<a name="l00934"></a>00934             <span class="keywordflow">if</span>( priority &lt;= pomInt &amp;&amp; pomS != <span class="stringliteral">&quot;Unavaliable&quot;</span> &amp;&amp; pomS != <span class="stringliteral">&quot;unavaliable&quot;</span>)
<a name="l00935"></a>00935             {
<a name="l00936"></a>00936                priority = pomInt;
<a name="l00937"></a>00937                culomn = i;
<a name="l00938"></a>00938             }
<a name="l00939"></a>00939       }
<a name="l00940"></a>00940       <span class="keywordflow">if</span>( culomn != -1 )
<a name="l00941"></a>00941          updateTableStatus( PQgetvalue(this-&gt;m_presult,culomn,1), PQgetvalue(m_presult,culomn,2), PQgetvalue(m_presult,culomn,3), PQgetvalue(m_presult,culomn,6), PQgetvalue(m_presult, culomn, 7), PQgetvalue(m_presult,culomn,14), PQgetvalue(m_presult,culomn,13), PQgetvalue(m_presult,culomn,15), PQgetvalue(m_presult, culomn, 16) );
<a name="l00942"></a>00942       <span class="keywordflow">else</span>
<a name="l00943"></a>00943       {
<a name="l00944"></a>00944          <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nTuples; i++ )
<a name="l00945"></a>00945          {
<a name="l00946"></a>00946             pom = PQgetvalue(this-&gt;m_presult,i,5);
<a name="l00947"></a>00947             pomS = PQgetvalue(this-&gt;m_presult,i,2);
<a name="l00948"></a>00948             std::string some_string;
<a name="l00949"></a>00949             std::istringstream buffer(pom);
<a name="l00950"></a>00950             buffer &gt;&gt; pomInt;
<a name="l00951"></a>00951             <span class="keywordflow">if</span>( priority &lt;= pomInt )
<a name="l00952"></a>00952             {
<a name="l00953"></a>00953                priority = pomInt;
<a name="l00954"></a>00954                culomn = i;
<a name="l00955"></a>00955             }
<a name="l00956"></a>00956          }
<a name="l00957"></a>00957          <span class="keywordflow">if</span>( culomn != -1 )
<a name="l00958"></a>00958             updateTableStatus( PQgetvalue(this-&gt;m_presult,culomn,1), PQgetvalue(m_presult,culomn,2), PQgetvalue(m_presult,culomn,3), PQgetvalue(m_presult,culomn,6), PQgetvalue(m_presult, culomn, 7), PQgetvalue(m_presult, culomn, 14), PQgetvalue(m_presult, culomn, 13), PQgetvalue(m_presult, culomn, 15), PQgetvalue(m_presult, culomn, 16) );
<a name="l00959"></a>00959       }
<a name="l00960"></a>00960    }
<a name="l00961"></a>00961 }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963 <span class="comment">// aktualizauje stav tabulky RESOURCE</span>
<a name="l00964"></a><a class="code" href="classDatabase.html#a3d21c62cf45f895d5bea438b1279370d">00964</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#af70354123caedcc69d3ce905e04c35ff">Database::updateTableResource</a>( std::string jidBare,std::string resource,std::string nameSW,std::string versionSW,std::string osSW) {
<a name="l00965"></a>00965 
<a name="l00966"></a>00966    std::string query = DB_UPDATE;
<a name="l00967"></a>00967    query += <span class="stringliteral">&quot;resource &quot;</span>;
<a name="l00968"></a>00968    query += DB_SET;
<a name="l00969"></a>00969    query += <span class="stringliteral">&quot;nameSW = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(nameSW) + <span class="stringliteral">&quot;&#39;, versionSW = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(versionSW) + <span class="stringliteral">&quot;&#39;, osSW = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(osSW) +<span class="stringliteral">&quot;&#39; &quot;</span> + DB_WHERE + <span class="stringliteral">&quot;jidbare = &#39;&quot;</span> +jidBare+<span class="stringliteral">&quot;&#39; AND resource = &#39;&quot;</span>+resource+<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00970"></a>00970    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00971"></a>00971    <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00972"></a>00972    {
<a name="l00973"></a>00973       PQclear(this-&gt;m_presult);
<a name="l00974"></a>00974       Database::exitError();
<a name="l00975"></a>00975    }
<a name="l00976"></a>00976    PQclear(this-&gt;m_presult);
<a name="l00977"></a>00977 }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979 <span class="comment">// aktualizauje stav tabulky RESOURCE</span>
<a name="l00980"></a><a class="code" href="classDatabase.html#ae80a2a2b6a33748bee20b62780f43fc3">00980</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#af70354123caedcc69d3ce905e04c35ff">Database::updateTableResource</a>( <a class="code" href="classSwVersion.html">SwVersion</a>* swVersion ) {
<a name="l00981"></a>00981 
<a name="l00982"></a>00982    std::string query = DB_UPDATE;
<a name="l00983"></a>00983    query += <span class="stringliteral">&quot;resource &quot;</span>;
<a name="l00984"></a>00984    query += DB_SET;
<a name="l00985"></a>00985    <span class="keywordflow">if</span>( (swVersion-&gt;<a class="code" href="classSwVersion.html#ab40b0d69e556dec6befaf28b438521ea">version</a>() != <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; (swVersion-&gt;osVersion() != <span class="stringliteral">&quot;&quot;</span>) )
<a name="l00986"></a>00986       query += <span class="stringliteral">&quot;nameSW = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( swVersion-&gt;<a class="code" href="classSwVersion.html#a3a830f6fdca767478505d6f9fa9fc0e8">name</a>() ) + <span class="stringliteral">&quot;&#39;, versionSW = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( swVersion-&gt;<a class="code" href="classSwVersion.html#ab40b0d69e556dec6befaf28b438521ea">version</a>() )+ <span class="stringliteral">&quot;&#39;, osSW = &#39;&quot;</span> +<a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>(swVersion-&gt;os() ) + <span class="stringliteral">&quot;&#39;, &#39;osVersion = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( swVersion-&gt;osVersion() ) + <span class="stringliteral">&quot;&#39;, category = &#39;&quot;</span> + swVersion-&gt;category() + <span class="stringliteral">&quot;&#39;,type = &#39;&quot;</span> + swVersion-&gt;type() + <span class="stringliteral">&quot;&#39;, jingleVoice = &quot;</span> +swVersion-&gt;jingleVoice() + <span class="stringliteral">&quot;, jingleVideo = &quot;</span> + swVersion-&gt;jingleVideo() + <span class="stringliteral">&quot;, googleVideo = &quot;</span> + swVersion-&gt;googleVideo() + <span class="stringliteral">&quot;, googleVoice = &quot;</span> + swVersion-&gt;googleVoice() + <span class="stringliteral">&quot; &quot;</span>+  DB_WHERE + <span class="stringliteral">&quot;jidbare = &#39;&quot;</span> + swVersion-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare()+<span class="stringliteral">&quot;&#39; AND resource = &#39;&quot;</span>+swVersion-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().resource()+<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00987"></a>00987    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (swVersion-&gt;<a class="code" href="classSwVersion.html#ab40b0d69e556dec6befaf28b438521ea">version</a>() == <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; (swVersion-&gt;osVersion() == <span class="stringliteral">&quot;&quot;</span>) )
<a name="l00988"></a>00988       query += <span class="stringliteral">&quot;nameSW = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( swVersion-&gt;<a class="code" href="classSwVersion.html#a3a830f6fdca767478505d6f9fa9fc0e8">name</a>() ) + <span class="stringliteral">&quot;&#39;, category = &#39;&quot;</span> + swVersion-&gt;category() + <span class="stringliteral">&quot;&#39;,type = &#39;&quot;</span> + <a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">convertXML</a>( swVersion-&gt;type() ) + <span class="stringliteral">&quot;&#39;, jingleVoice = &quot;</span> +swVersion-&gt;jingleVoice() + <span class="stringliteral">&quot;, jingleVideo = &quot;</span> + swVersion-&gt;jingleVideo() + <span class="stringliteral">&quot;, googleVideo = &quot;</span> + swVersion-&gt;googleVideo() + <span class="stringliteral">&quot;, googleVoice = &quot;</span> + swVersion-&gt;googleVoice() + <span class="stringliteral">&quot; &quot;</span>+  DB_WHERE + <span class="stringliteral">&quot;jidbare = &#39;&quot;</span> + swVersion-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().bare()+<span class="stringliteral">&quot;&#39; AND resource = &#39;&quot;</span>+swVersion-&gt;<a class="code" href="classExtension.html#a47d1a1c66961799083e274e6bd5f8b7e">jid</a>().resource()+<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00989"></a>00989    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l00990"></a>00990    <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l00991"></a>00991    {
<a name="l00992"></a>00992       PQclear(this-&gt;m_presult);
<a name="l00993"></a>00993       Database::exitError();
<a name="l00994"></a>00994    }
<a name="l00995"></a>00995    PQclear(this-&gt;m_presult);
<a name="l00996"></a>00996 }
<a name="l00997"></a>00997 
<a name="l00998"></a>00998 <span class="comment">// aktualizauje stav tabulky RESOURCE</span>
<a name="l00999"></a><a class="code" href="classDatabase.html#a808c8a5de4206ca72a69a122b8832811">00999</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#af70354123caedcc69d3ce905e04c35ff">Database::updateTableResource</a>( std::string jidBare,std::string presence,std::string status,std::string resource, <span class="keywordtype">int</span> priority,std::string ver) {
<a name="l01000"></a>01000 
<a name="l01001"></a>01001    <span class="keywordtype">bool</span> update = <span class="keyword">false</span>;
<a name="l01002"></a>01002    std::string query = DB_UPDATE;
<a name="l01003"></a>01003    <span class="keywordflow">if</span>( existResource(jidBare, resource) ) <span class="comment">//uzivatelsky ucet s mistem existuje, aktualizuji</span>
<a name="l01004"></a>01004    {
<a name="l01005"></a>01005       query += <span class="stringliteral">&quot;resource &quot;</span>;
<a name="l01006"></a>01006       query += DB_SET;
<a name="l01007"></a>01007       query += <span class="stringliteral">&quot;presence = &#39;&quot;</span>+presence+<span class="stringliteral">&quot;&#39;, status = &#39;&quot;</span>+<a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(status)+<span class="stringliteral">&quot;&#39;, date = timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, priority=&quot;</span> + numToStr(priority) + <span class="stringliteral">&quot;, ver = &#39;&quot;</span> + ver + <span class="stringliteral">&quot;&#39; &quot;</span> + DB_WHERE + <span class="stringliteral">&quot;jidbare = &#39;&quot;</span> +jidBare+<span class="stringliteral">&quot;&#39; AND resource = &#39;&quot;</span>+resource+<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l01008"></a>01008       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l01009"></a>01009       <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l01010"></a>01010       {
<a name="l01011"></a>01011          PQclear(this-&gt;m_presult);
<a name="l01012"></a>01012          Database::exitError();
<a name="l01013"></a>01013       }
<a name="l01014"></a>01014       update = <span class="keyword">true</span>;
<a name="l01015"></a>01015    }
<a name="l01016"></a>01016    <span class="keywordflow">else</span>              <span class="comment">// uzivatel s uctem neexistuje, vytvorim</span>
<a name="l01017"></a>01017    {
<a name="l01018"></a>01018       query = DB_INSERT;
<a name="l01019"></a>01019       query += <span class="stringliteral">&quot;resource (jidbare, presence, status, date, priority, resource, ver) VALUES (&#39;&quot;</span>+ jidBare + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span>+ presence +<span class="stringliteral">&quot;&#39;, &#39;&quot;</span>+<a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(status)+<span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span> +<a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, &quot;</span>+ numToStr(priority)+<span class="stringliteral">&quot;, &#39;&quot;</span>+resource+<span class="stringliteral">&quot;&#39;, &#39;&quot;</span>+ver+<span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l01020"></a>01020       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l01021"></a>01021       <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l01022"></a>01022       {
<a name="l01023"></a>01023          PQclear(this-&gt;m_presult);
<a name="l01024"></a>01024          Database::exitError();
<a name="l01025"></a>01025       }
<a name="l01026"></a>01026       update = <span class="keyword">false</span>;
<a name="l01027"></a>01027    }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029    PQclear(this-&gt;m_presult);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    <span class="keywordflow">return</span> update;
<a name="l01032"></a>01032 }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 <span class="comment">// aktualizauje stav tabulky RESOURCE</span>
<a name="l01035"></a><a class="code" href="classDatabase.html#af70354123caedcc69d3ce905e04c35ff">01035</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#af70354123caedcc69d3ce905e04c35ff">Database::updateTableResource</a>( std::string jidBare,std::string presence,std::string status,std::string resource, <span class="keywordtype">int</span> priority) {
<a name="l01036"></a>01036 
<a name="l01037"></a>01037    <span class="keywordtype">bool</span> update = <span class="keyword">false</span>;
<a name="l01038"></a>01038    std::string query = DB_UPDATE;
<a name="l01039"></a>01039    <span class="keywordflow">if</span>( existResource(jidBare, resource) ) <span class="comment">//uzivatelsky ucet s mistem existuje, aktualizuji</span>
<a name="l01040"></a>01040    {
<a name="l01041"></a>01041       query += <span class="stringliteral">&quot;resource &quot;</span>;
<a name="l01042"></a>01042       query += DB_SET;
<a name="l01043"></a>01043       query += <span class="stringliteral">&quot;presence = &#39;&quot;</span>+presence+<span class="stringliteral">&quot;&#39;, status = &#39;&quot;</span>+<a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(status)+<span class="stringliteral">&quot;&#39;, date = timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, priority=&quot;</span> + numToStr(priority) + <span class="stringliteral">&quot; &quot;</span> + DB_WHERE + <span class="stringliteral">&quot;jidbare = &#39;&quot;</span> +jidBare+<span class="stringliteral">&quot;&#39; AND resource = &#39;&quot;</span>+resource+<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l01044"></a>01044       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l01045"></a>01045       <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l01046"></a>01046       {
<a name="l01047"></a>01047          PQclear(this-&gt;m_presult);
<a name="l01048"></a>01048          Database::exitError();
<a name="l01049"></a>01049       }
<a name="l01050"></a>01050       update = <span class="keyword">true</span>;
<a name="l01051"></a>01051    }
<a name="l01052"></a>01052    <span class="keywordflow">else</span>              <span class="comment">// uzivatel s uctem neexistuje, vytvorim</span>
<a name="l01053"></a>01053    {
<a name="l01054"></a>01054       query = DB_INSERT;
<a name="l01055"></a>01055       query += <span class="stringliteral">&quot;resource (jidbare, presence, status, date, priority, resource) VALUES (&#39;&quot;</span>+ jidBare + <span class="stringliteral">&quot;&#39;, &#39;&quot;</span>+ presence +<span class="stringliteral">&quot;&#39;, &#39;&quot;</span>+<a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(status)+<span class="stringliteral">&quot;&#39;, timestamp &#39;&quot;</span> +<a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39;, &quot;</span>+ numToStr(priority)+<span class="stringliteral">&quot;, &#39;&quot;</span>+resource+<span class="stringliteral">&quot;&#39;);&quot;</span>;
<a name="l01056"></a>01056       this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l01057"></a>01057       <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l01058"></a>01058       {
<a name="l01059"></a>01059          PQclear(this-&gt;m_presult);
<a name="l01060"></a>01060          Database::exitError();
<a name="l01061"></a>01061       }
<a name="l01062"></a>01062       update = <span class="keyword">false</span>;
<a name="l01063"></a>01063    }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    PQclear(this-&gt;m_presult);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067    <span class="keywordflow">return</span> update;
<a name="l01068"></a>01068 }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070 <span class="comment">// aktualizauje stav tabulky RESOURCE</span>
<a name="l01071"></a><a class="code" href="classDatabase.html#a9abb11cd73e399d8f872ed6a19ff1d0c">01071</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#af70354123caedcc69d3ce905e04c35ff">Database::updateTableResource</a>( std::string jidBare,std::string presence,std::string status,std::string resource) {
<a name="l01072"></a>01072 
<a name="l01073"></a>01073    std::string query = DB_UPDATE;
<a name="l01074"></a>01074    query += <span class="stringliteral">&quot;resource &quot;</span>;
<a name="l01075"></a>01075    query += DB_SET;
<a name="l01076"></a>01076    query += <span class="stringliteral">&quot;presence = &#39;&quot;</span>+presence+<span class="stringliteral">&quot;&#39;, status = &#39;&quot;</span>+<a class="code" href="classDatabase.html#a491ca397cd5339ddc2474e64e1b66b00">Database::convertXML</a>(status)+<span class="stringliteral">&quot;&#39;, date = timestamp &#39;&quot;</span> + <a class="code" href="classDatabase.html#a0be1ba1393e19becbeffed6b15fcfe91">getTime</a>() + <span class="stringliteral">&quot;&#39; &quot;</span> + DB_WHERE + <span class="stringliteral">&quot;jidbare = &#39;&quot;</span> +jidBare+<span class="stringliteral">&quot;&#39; AND resource = &#39;&quot;</span>+resource+<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l01077"></a>01077    this-&gt;m_presult = PQexec( this-&gt;m_psql, query.c_str() );
<a name="l01078"></a>01078    <span class="keywordflow">if</span>( PQresultStatus(this-&gt;m_presult) != PGRES_COMMAND_OK )
<a name="l01079"></a>01079    {
<a name="l01080"></a>01080       PQclear(this-&gt;m_presult);
<a name="l01081"></a>01081       Database::exitError();
<a name="l01082"></a>01082    }
<a name="l01083"></a>01083    PQclear(this-&gt;m_presult);
<a name="l01084"></a>01084 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Sat May 7 2011 20:45:12 for IBP by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
